pipeline {
    agent any

    environment {
        APP_NAME = "tech-assessment-app"
        DEPLOY_DIR = "/opt/apps/tech-assessment-app"
        JAR_FILE = "target/${APP_NAME}.jar"
        // Use the JDK tool configured in Jenkins Global Tool with name 'JDK21'
        JAVA_HOME = "${tool 'JDK21'}"
        PATH = "${JAVA_HOME}/bin:${env.PATH}"
        // Email recipients (comma separated)
        NOTIFY_RECIPIENTS = "ram.verma@fulcrumdigital.com"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/ramverma-github/tech-assessment-app.git'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Stop existing process on 9090, if any
                    sh '''
                      pid=$(lsof -t -i:9090 || true)
                      if [ -n "$pid" ]; then
                        echo "Stopping existing application with PID $pid"
                        kill -9 $pid || true
                        sleep 2
                      fi
                    '''

                    // ensure deploy dir
                    sh "mkdir -p ${DEPLOY_DIR}"
                    // copy artifact
                    sh "cp ${JAR_FILE} ${DEPLOY_DIR}/${APP_NAME}.jar"

                    // start new instance in background
                    sh """
                      nohup java -jar ${DEPLOY_DIR}/${APP_NAME}.jar > ${DEPLOY_DIR}/app.log 2>&1 &
                      echo $! > ${DEPLOY_DIR}/app.pid
                      echo "Application deployed successfully at http://localhost:8080"
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                emailext subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} succeeded. Check console: ${env.BUILD_URL}",
                        to: "${NOTIFY_RECIPIENTS}"
            }
        }
        failure {
            script {
                emailext subject: "FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} failed. Check console: ${env.BUILD_URL}",
                        to: "${NOTIFY_RECIPIENTS}"
            }
        }
    }
}